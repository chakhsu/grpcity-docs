(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4277],{6945:function(e,i,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/en-US/guide/middleware",function(){return s(5821)}])},5821:function(e,i,s){"use strict";s.r(i),s.d(i,{default:function(){return HOC},useTOC:function(){return useTOC}});var r=s(5893),n=s(7812),a=s(1054),t=s(8925),d=s(5192);function useTOC(e){return[{value:"Usage",id:"usage",depth:3},{value:"Writing Middleware",id:"writing-middleware",depth:3}]}let l=(0,n.c)(function(e){let{toc:i=useTOC(e)}=e,s=Object.assign({h1:"h1",p:"p",code:"code",pre:"pre",span:"span",h3:"h3",ul:"ul",li:"li"},(0,t.a)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h1,{children:"Middleware"}),"\n",(0,r.jsxs)(s.p,{children:["Middleware is an essential feature in ",(0,r.jsx)(s.code,{children:"gRPCity"}),", providing the ability to execute middleware code before and after handling RPC calls.\nMiddleware plays a convenient role in scenarios such as uniform call logging, monitoring metric collection, authentication, parameter modification, result modification, and delay.\nThis helps improve development efficiency in handling business logic."]}),"\n",(0,r.jsxs)(s.p,{children:["The middleware implementation in ",(0,r.jsx)(s.code,{children:"gRPCity"})," is based on the ",(0,r.jsx)(s.code,{children:"koa-compose"})," library, which provides an onion model working mechanism for executing middleware."]}),"\n",(0,r.jsxs)(s.p,{children:["Suppose we have three middleware functions: A, B, and C. The order in which middleware is executed is ",(0,r.jsx)(s.code,{children:"A -> B -> C"}),". Here's how it works:"]}),"\n",(0,r.jsx)(s.pre,{"data-language":"","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"enter A"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"  enter B"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"    enter C"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"      rpc-method()"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"    exit C"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"  exit B"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"exit A"})})]})}),"\n",(0,r.jsx)(s.h3,{id:i[0].id,children:i[0].value}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"gRPCity"})," server provides two methods to support middleware: ",(0,r.jsx)(s.code,{children:"server.addMiddleware(fn)"})," and ",(0,r.jsx)(s.code,{children:"server.addMiddlewares(fns)"}),"."]}),"\n",(0,r.jsx)(s.p,{children:"The difference between the two methods is that one can only pass a single middleware, while the other can accept multiple middlewares, as follows:"}),"\n",(0,r.jsx)(s.pre,{icon:d.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(a)"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(b)"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(c)"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// Equivalent to"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"([a, b, c])"})]})]})}),"\n",(0,r.jsxs)(s.p,{children:["You can add middleware after initializing the server with ",(0,r.jsx)(s.code,{children:"initServer()"})," and before calling ",(0,r.jsx)(s.code,{children:"listen()"}),"."]}),"\n",(0,r.jsx)(s.h3,{id:i[1].id,children:i[1].value}),"\n",(0,r.jsx)(s.p,{children:"Here, we will demonstrate how to write middleware for logging RPC calls."}),"\n",(0,r.jsxs)(s.p,{children:["Middleware functions support two parameters: ",(0,r.jsx)(s.code,{children:"ctx"})," and ",(0,r.jsx)(s.code,{children:"next"}),", as follows:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"ctx"}),": An object that represents the middleware context.","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"path"}),": The RPC route path."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"request"}),": The RPC request parameters."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"metadata"}),": Metadata from the client."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"response"}),": The result returned by the RPC method, which is available only after the RPC method is executed."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"next"}),": A function that executes the next middleware or the actual method."]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{"data-language":"javascript","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"class"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" Log"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" {"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"  async"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" middleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"("}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"},children:"ctx"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:", "}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"},children:"next"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:") {"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"    const"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" startTime"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" ="}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" Date."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"now"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"    await"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" next"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"    const"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" responseTimeMs"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" ="}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" Date."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"now"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"() "}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"-"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" startTime"})]}),"\n",(0,r.jsx)(s.span,{children:" "}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"    console."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"log"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"({"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"        path: ctx.path,"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"        request: ctx.request,"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"        responseTimeMs"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"    })"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"  }"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"}"})}),"\n",(0,r.jsx)(s.span,{children:" "}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"export"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" default"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" new"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" Log"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]})]})}),"\n",(0,r.jsx)(s.p,{children:"To add the middleware:"}),"\n",(0,r.jsx)(s.pre,{"data-language":"javascript","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"import"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" log "}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"from"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"},children:" './log.js'"})]}),"\n",(0,r.jsx)(s.span,{children:" "}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(log.middleware)"})]})]})}),"\n",(0,r.jsx)(s.p,{children:"With these steps, you have completed writing and using middleware."})]})},"/en-US/guide/middleware",{filePath:"pages/en-US/guide/middleware.mdx",timestamp:1699236606e3,pageMap:a.v,frontMatter:{},title:"Middleware"},"undefined"==typeof RemoteContent?useTOC:RemoteContent.useTOC);function HOC(e){return l(e)}},1054:function(e,i,s){"use strict";s.d(i,{v:function(){return r}});let r=[{data:{index:"Home",start:"Get Started",guide:"User Guide",apis:"API"}},{name:"apis",route:"/en-US/apis",children:[{data:{grpcloader:"gRPC Loader",server:"Server","client-proxy":"Client Proxy"}},{name:"client-proxy",route:"/en-US/apis/client-proxy",frontMatter:{sidebar_label:"Client Proxy"}},{name:"grpcloader",route:"/en-US/apis/grpcloader",frontMatter:{sidebar_label:"Grpcloader"}},{name:"server",route:"/en-US/apis/server",frontMatter:{sidebar_label:"Server"}}]},{name:"apis",route:"/en-US/apis",frontMatter:{sidebar_label:"Apis"}},{name:"guide",route:"/en-US/guide",children:[{data:{loader:"Loader",config:"Config",server:"Server",client:"Client",metadata:"Metadata","stream-v2":"Stream v2",stream:"Stream",credentials:"Credentials",status:"Status",error:"Error",middleware:"Middleware",proto:"Proto"}},{name:"client",route:"/en-US/guide/client",frontMatter:{sidebar_label:"Client"}},{name:"config",route:"/en-US/guide/config",frontMatter:{sidebar_label:"Config"}},{name:"credentials",route:"/en-US/guide/credentials",frontMatter:{sidebar_label:"Credentials"}},{name:"error",route:"/en-US/guide/error",frontMatter:{sidebar_label:"Error"}},{name:"loader",route:"/en-US/guide/loader",frontMatter:{sidebar_label:"Loader"}},{name:"metadata",route:"/en-US/guide/metadata",frontMatter:{sidebar_label:"Metadata"}},{name:"middleware",route:"/en-US/guide/middleware",frontMatter:{sidebar_label:"Middleware"}},{name:"proto",route:"/en-US/guide/proto",frontMatter:{sidebar_label:"Proto"}},{name:"server",route:"/en-US/guide/server",frontMatter:{sidebar_label:"Server"}},{name:"status",route:"/en-US/guide/status",frontMatter:{sidebar_label:"Status"}},{name:"stream-v2",route:"/en-US/guide/stream-v2",frontMatter:{sidebar_label:"Stream V2"}},{name:"stream",route:"/en-US/guide/stream",frontMatter:{sidebar_label:"Stream"}}]},{name:"guide",route:"/en-US/guide",frontMatter:{sidebar_label:"Guide"}},{name:"index",route:"/en-US",frontMatter:{sidebar_label:"Index"}},{name:"start",route:"/en-US/start",children:[{data:{"proto-loader":"Proto Loader",server:"Server Side",client:"Client Side"}},{name:"client",route:"/en-US/start/client",frontMatter:{sidebar_label:"Client"}},{name:"proto-loader",route:"/en-US/start/proto-loader",frontMatter:{sidebar_label:"Proto Loader"}},{name:"server",route:"/en-US/start/server",frontMatter:{sidebar_label:"Server"}}]},{name:"start",route:"/en-US/start",frontMatter:{sidebar_label:"Start"}}]}},function(e){e.O(0,[7812,9774,2888,179],function(){return e(e.s=6945)}),_N_E=e.O()}]);