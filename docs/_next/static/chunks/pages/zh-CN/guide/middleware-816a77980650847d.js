(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5363],{6016:function(e,i,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/zh-CN/guide/middleware",function(){return s(909)}])},909:function(e,i,s){"use strict";s.r(i),s.d(i,{default:function(){return HOC},useTOC:function(){return useTOC}});var r=s(5893),n=s(7812),a=s(5493),l=s(8925),d=s(5192);function useTOC(e){return[{value:"原理",id:"原理",depth:3},{value:"用法",id:"用法",depth:3},{value:"编写中间件",id:"编写中间件",depth:3}]}let t=(0,n.c)(function(e){let{toc:i=useTOC(e)}=e,s=Object.assign({h1:"h1",p:"p",code:"code",h3:"h3",pre:"pre",span:"span",ul:"ul",li:"li"},(0,l.a)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h1,{children:"Middleware"}),"\n",(0,r.jsxs)(s.p,{children:["中间件是 ",(0,r.jsx)(s.code,{children:"gRPCity"})," 提供 server 能力中的一个重要功能，它让我们能够在执行 rpc 处理之前和之后执行中间件代码。"]}),"\n",(0,r.jsx)(s.p,{children:"像统一调用日志打印，监控指标采集，鉴权，修改传参，修改结果和延时等业务场景中，中间件发挥非常便利的作用，使得我们处理业务能够提升开发效率。"}),"\n",(0,r.jsx)(s.h3,{id:i[0].id,children:i[0].value}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"gRPCity"}),"的中间件实现是基于",(0,r.jsx)(s.code,{children:"koa-compose"}),"库，它提供了洋葱模型的工作机制，方便我们去执行中间件。"]}),"\n",(0,r.jsxs)(s.p,{children:["假如我们有 a、b、c 这三个中间件，中间件执行的顺序是",(0,r.jsx)(s.code,{children:"a → b → c"}),"，如下所示:"]}),"\n",(0,r.jsx)(s.pre,{"data-language":"","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"enter a"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"  enter b"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"    enter c"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"      rpc-method()"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"    exit  c"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"  exit  b"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{children:"exit  a"})})]})}),"\n",(0,r.jsx)(s.h3,{id:i[1].id,children:i[1].value}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"gRPCity"})," server 提供了两个方法去支持中间件，分别是",(0,r.jsx)(s.code,{children:"server.addMiddleware(fn)"}),"和",(0,r.jsx)(s.code,{children:"server.addMiddlewares(fns)"}),"。"]}),"\n",(0,r.jsx)(s.p,{children:"两个方法区别就是一个只能传入一个中间件，另外一个可以传入多个中间件，如:"}),"\n",(0,r.jsx)(s.pre,{icon:d.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(a)"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(b)"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(c)"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// 等于"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"([a, b, c])"})]})]})}),"\n",(0,r.jsxs)(s.p,{children:["添加中间件的使用位置在",(0,r.jsx)(s.code,{children:"initServer()"}),"之后，在",(0,r.jsx)(s.code,{children:"listen()"}),"之前。"]}),"\n",(0,r.jsx)(s.h3,{id:i[2].id,children:i[2].value}),"\n",(0,r.jsx)(s.p,{children:"在这里我们将演示可以编写 rpc 调用日志打印的中间件。"}),"\n",(0,r.jsxs)(s.p,{children:["中间件方法支持两个参数，分别是",(0,r.jsx)(s.code,{children:"ctx"}),"和",(0,r.jsx)(s.code,{children:"next"}),"，详情如下:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"ctx"}),": ",(0,r.jsx)(s.code,{children:"object"}),"类型，中间件上下文;","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"path"}),": rpc 路由路径；"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"request"}),": rpc 请求参数；"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"metadata"}),": 来自客户端的",(0,r.jsx)(s.code,{children:"metadata"}),"；"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"response"})," rpc method 返回结果，需要 rpc method 执行后才会有的；"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"next"}),": ",(0,r.jsx)(s.code,{children:"function"}),"类型，执行下一个中间件或者方法本体;"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{icon:d.Dr,"data-language":"js","data-filename":"log.js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"class"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" Log"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" {"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"  async"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" middleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" ("}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"},children:"ctx"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:", "}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"},children:"next"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:") {"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"    const"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" startTime"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" ="}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" Date."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"now"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"    await"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" next"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"    const"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" responseTimeMs"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" ="}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" Date."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"now"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"() "}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"-"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" startTime"})]}),"\n",(0,r.jsx)(s.span,{children:" "}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"    console."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"log"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"({"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"        path: ctx.path,"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"        request: ctx.request,"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"        responseTimeMs"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"    })"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"  }"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"}"})}),"\n",(0,r.jsx)(s.span,{children:" "}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"export"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" default"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" new"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:" Log"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]})]})}),"\n",(0,r.jsx)(s.p,{children:"添加中间件"}),"\n",(0,r.jsx)(s.pre,{icon:d.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"import"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" log "}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"from"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"},children:" './log.js'"})]}),"\n",(0,r.jsx)(s.span,{children:" "}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(log.middleware)"})]})]})}),"\n",(0,r.jsx)(s.p,{children:"至此，我们完成了中间件的编写与使用。"})]})},"/zh-CN/guide/middleware",{filePath:"pages/zh-CN/guide/middleware.mdx",timestamp:1699236606e3,pageMap:a.v,frontMatter:{},title:"Middleware"},"undefined"==typeof RemoteContent?useTOC:RemoteContent.useTOC);function HOC(e){return t(e)}},5493:function(e,i,s){"use strict";s.d(i,{v:function(){return r}});let r=[{data:{index:"首页",start:"快速开始",guide:"用户指南",apis:"API"}},{name:"apis",route:"/zh-CN/apis",children:[{data:{grpcloader:"gRPC Loader",server:"Server","client-proxy":"Client Proxy"}},{name:"client-proxy",route:"/zh-CN/apis/client-proxy",frontMatter:{sidebar_label:"Client Proxy"}},{name:"grpcloader",route:"/zh-CN/apis/grpcloader",frontMatter:{sidebar_label:"Grpcloader"}},{name:"server",route:"/zh-CN/apis/server",frontMatter:{sidebar_label:"Server"}}]},{name:"apis",route:"/zh-CN/apis",frontMatter:{sidebar_label:"Apis"}},{name:"guide",route:"/zh-CN/guide",children:[{data:{loader:"Loader",config:"Config",server:"Server",client:"Client",metadata:"Metadata","stream-v2":"Stream v2",stream:"Stream",credentials:"Credentials",status:"Status",error:"Error",middleware:"Middleware",proto:"Proto"}},{name:"client",route:"/zh-CN/guide/client",frontMatter:{sidebar_label:"Client"}},{name:"config",route:"/zh-CN/guide/config",frontMatter:{sidebar_label:"Config"}},{name:"credentials",route:"/zh-CN/guide/credentials",frontMatter:{sidebar_label:"Credentials"}},{name:"error",route:"/zh-CN/guide/error",frontMatter:{sidebar_label:"Error"}},{name:"loader",route:"/zh-CN/guide/loader",frontMatter:{sidebar_label:"Loader"}},{name:"metadata",route:"/zh-CN/guide/metadata",frontMatter:{sidebar_label:"Metadata"}},{name:"middleware",route:"/zh-CN/guide/middleware",frontMatter:{sidebar_label:"Middleware"}},{name:"proto",route:"/zh-CN/guide/proto",frontMatter:{sidebar_label:"Proto"}},{name:"server",route:"/zh-CN/guide/server",frontMatter:{sidebar_label:"Server"}},{name:"status",route:"/zh-CN/guide/status",frontMatter:{sidebar_label:"Status"}},{name:"stream-v2",route:"/zh-CN/guide/stream-v2",frontMatter:{sidebar_label:"Stream V2"}},{name:"stream",route:"/zh-CN/guide/stream",frontMatter:{sidebar_label:"Stream"}}]},{name:"guide",route:"/zh-CN/guide",frontMatter:{sidebar_label:"Guide"}},{name:"index",route:"/zh-CN",frontMatter:{sidebar_label:"Index"}},{name:"start",route:"/zh-CN/start",children:[{data:{"proto-loader":"Proto Loader",server:"Server Side",client:"Client Side"}},{name:"client",route:"/zh-CN/start/client",frontMatter:{sidebar_label:"Client"}},{name:"proto-loader",route:"/zh-CN/start/proto-loader",frontMatter:{sidebar_label:"Proto Loader"}},{name:"server",route:"/zh-CN/start/server",frontMatter:{sidebar_label:"Server"}}]},{name:"start",route:"/zh-CN/start",frontMatter:{sidebar_label:"Start"}}]}},function(e){e.O(0,[7812,9774,2888,179],function(){return e(e.s=6016)}),_N_E=e.O()}]);