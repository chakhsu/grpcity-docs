(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3924],{3836:function(e,i,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/zh-CN/guide/server",function(){return s(5767)}])},5767:function(e,i,s){"use strict";s.r(i),s.d(i,{default:function(){return HOC},useTOC:function(){return useTOC}});var r=s(5893),n=s(7812),a=s(5493),d=s(8925),t=s(5192);function useTOC(e){return[{value:"实例获取",id:"实例获取",depth:3},{value:"服务绑定",id:"服务绑定",depth:3},{value:"添加中间件",id:"添加中间件",depth:3},{value:"证书与启动",id:"证书与启动",depth:3},{value:"服务退出",id:"服务退出",depth:3}]}let l=(0,n.c)(function(e){let{toc:i=useTOC(e)}=e,s=Object.assign({h1:"h1",p:"p",code:"code",h3:"h3",a:"a",pre:"pre",span:"span",ul:"ul",li:"li"},(0,d.a)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h1,{children:"Server"}),"\n",(0,r.jsxs)(s.p,{children:["Server是",(0,r.jsx)(s.code,{children:"gRPCity"}),"的核心功能之一，提供了服务端生命周期的接管能力。通过一系列的接口函数，提供了从证书导入、服务绑定、中间件支持，服务启动和服务退出等，全周期的管理。"]}),"\n",(0,r.jsx)(s.h3,{id:i[0].id,children:i[0].value}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"channelOptions"}),"在 ",(0,r.jsx)(s.a,{href:"/guide/config",children:"Config 指南"})," 里有详细讲解。"]}),"\n",(0,r.jsx)(s.pre,{icon:t.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// 获取 server 实例"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"const"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" server"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" ="}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" loader."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"initServer"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(channelOptions)"})]})]})}),"\n",(0,r.jsxs)(s.p,{children:["得到",(0,r.jsx)(s.code,{children:"server"}),"实例后，实例会有一系列的接口来帮助我们开发服务。"]}),"\n",(0,r.jsx)(s.h3,{id:i[1].id,children:i[1].value}),"\n",(0,r.jsxs)(s.p,{children:["服务绑定需要两个参数，一个是",(0,r.jsx)(s.code,{children:"service"}),"，另外一个是",(0,r.jsx)(s.code,{children:"implementation"}),"。"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"service"}),": (必填) 需要通过",(0,r.jsx)(s.code,{children:"loader.service(name)"}),"来获取 proto 里指定的",(0,r.jsx)(s.code,{children:"service"}),"；"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"implementation"}),": (必填) 携带 service rpc 定义好的方法的对象或者类，需要通过",(0,r.jsx)(s.code,{children:"loader.callbackify()"}),"来",(0,r.jsx)(s.code,{children:"async"}),"化，并支持中间件；"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{icon:t.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// service rpc 绑定"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addService"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(service, implementation)"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// service rpc 解绑"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"removeService"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(service)"})]})]})}),"\n",(0,r.jsx)(s.h3,{id:i[2].id,children:i[2].value}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"gRPCity"})," Server 的特色功能，提供了",(0,r.jsx)(s.code,{children:"implementation"})," 前后处理的中间件能力，更多详情查看 ",(0,r.jsx)(s.a,{href:"/guide/middleware",children:"Middleware 指南"})]}),"\n",(0,r.jsxs)(s.p,{children:["注意: 只有使用了",(0,r.jsx)(s.code,{children:"loader.callbackify()"}),"绑定的",(0,r.jsx)(s.code,{children:"service"})," rpc 才支持中间件。"]}),"\n",(0,r.jsx)(s.pre,{icon:t.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// implementation 中间件支持"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddleware"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(fn)"})]}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"addMiddlewares"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(fns)"})]})]})}),"\n",(0,r.jsx)(s.h3,{id:i[3].id,children:i[3].value}),"\n",(0,r.jsxs)(s.p,{children:["服务启动 ",(0,r.jsx)(s.code,{children:"listen"})," 支持两个参数，分别是",(0,r.jsx)(s.code,{children:"addr"}),"和",(0,r.jsx)(s.code,{children:"credentials"}),":"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"addr"}),": (必选) 服务启动需要监听的地址和端口，支持类型如下，任选一个:","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["string: ip+port 格式，如 ",(0,r.jsx)(s.code,{children:"127.0.0.1:9099"}),"；"]}),"\n",(0,r.jsxs)(s.li,{children:["object: ",(0,r.jsx)(s.code,{children:"{ host, port }"}),"；","\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"host: 字符串，支持 ip 和域名；"}),"\n",(0,r.jsx)(s.li,{children:"port: 数字，最小值为0，最大值为65535；"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"credentials"}),": (可选) 使用",(0,r.jsx)(s.code,{children:"makeServerCredentials"}),"来生成，并给",(0,r.jsx)(s.code,{children:"listen"}),"调用；"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{icon:t.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// 服务端证书"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"const"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:" credentials"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:" ="}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"makeServerCredentials"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(rootCerts, keyCertPairs, checkClientCertificate)"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// 服务启动"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"await"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"listen"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(addr, credentials)"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// await server.listen('127.0.0.1:9099', credentials)"})}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// await server.listen({ host: '127.0.0.1', port: 9099 }, credentials)"})})]})}),"\n",(0,r.jsxs)(s.p,{children:["另外，可以阅读 ",(0,r.jsx)(s.a,{href:"/guide/credentials",children:"Credentials 指南"})," 来获得更多信息。"]}),"\n",(0,r.jsx)(s.h3,{id:i[4].id,children:i[4].value}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"shutdown()"})," 需要使用",(0,r.jsx)(s.code,{children:"async"}),"来保证异步执行完成，而",(0,r.jsx)(s.code,{children:"forceShutdown"}),"不需要。"]}),"\n",(0,r.jsx)(s.pre,{icon:t.Dr,"data-language":"js","data-copy":"",children:(0,r.jsxs)(s.code,{children:[(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// 服务优雅退出"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"},children:"await"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"shutdown"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]}),"\n",(0,r.jsx)(s.span,{children:(0,r.jsx)(s.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"// 服务强制退出"})}),"\n",(0,r.jsxs)(s.span,{children:[(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"server."}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"forceShutdown"}),(0,r.jsx)(s.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"()"})]})]})})]})},"/zh-CN/guide/server",{filePath:"pages/zh-CN/guide/server.mdx",timestamp:1699236606e3,pageMap:a.v,frontMatter:{},title:"Server"},"undefined"==typeof RemoteContent?useTOC:RemoteContent.useTOC);function HOC(e){return l(e)}},5493:function(e,i,s){"use strict";s.d(i,{v:function(){return r}});let r=[{data:{index:"首页",start:"快速开始",guide:"用户指南",apis:"API"}},{name:"apis",route:"/zh-CN/apis",children:[{data:{grpcloader:"gRPC Loader",server:"Server","client-proxy":"Client Proxy"}},{name:"client-proxy",route:"/zh-CN/apis/client-proxy",frontMatter:{sidebar_label:"Client Proxy"}},{name:"grpcloader",route:"/zh-CN/apis/grpcloader",frontMatter:{sidebar_label:"Grpcloader"}},{name:"server",route:"/zh-CN/apis/server",frontMatter:{sidebar_label:"Server"}}]},{name:"apis",route:"/zh-CN/apis",frontMatter:{sidebar_label:"Apis"}},{name:"guide",route:"/zh-CN/guide",children:[{data:{loader:"Loader",config:"Config",server:"Server",client:"Client",metadata:"Metadata","stream-v2":"Stream v2",stream:"Stream",credentials:"Credentials",status:"Status",error:"Error",middleware:"Middleware",proto:"Proto"}},{name:"client",route:"/zh-CN/guide/client",frontMatter:{sidebar_label:"Client"}},{name:"config",route:"/zh-CN/guide/config",frontMatter:{sidebar_label:"Config"}},{name:"credentials",route:"/zh-CN/guide/credentials",frontMatter:{sidebar_label:"Credentials"}},{name:"error",route:"/zh-CN/guide/error",frontMatter:{sidebar_label:"Error"}},{name:"loader",route:"/zh-CN/guide/loader",frontMatter:{sidebar_label:"Loader"}},{name:"metadata",route:"/zh-CN/guide/metadata",frontMatter:{sidebar_label:"Metadata"}},{name:"middleware",route:"/zh-CN/guide/middleware",frontMatter:{sidebar_label:"Middleware"}},{name:"proto",route:"/zh-CN/guide/proto",frontMatter:{sidebar_label:"Proto"}},{name:"server",route:"/zh-CN/guide/server",frontMatter:{sidebar_label:"Server"}},{name:"status",route:"/zh-CN/guide/status",frontMatter:{sidebar_label:"Status"}},{name:"stream-v2",route:"/zh-CN/guide/stream-v2",frontMatter:{sidebar_label:"Stream V2"}},{name:"stream",route:"/zh-CN/guide/stream",frontMatter:{sidebar_label:"Stream"}}]},{name:"guide",route:"/zh-CN/guide",frontMatter:{sidebar_label:"Guide"}},{name:"index",route:"/zh-CN",frontMatter:{sidebar_label:"Index"}},{name:"start",route:"/zh-CN/start",children:[{data:{"proto-loader":"Proto Loader",server:"Server Side",client:"Client Side"}},{name:"client",route:"/zh-CN/start/client",frontMatter:{sidebar_label:"Client"}},{name:"proto-loader",route:"/zh-CN/start/proto-loader",frontMatter:{sidebar_label:"Proto Loader"}},{name:"server",route:"/zh-CN/start/server",frontMatter:{sidebar_label:"Server"}}]},{name:"start",route:"/zh-CN/start",frontMatter:{sidebar_label:"Start"}}]}},function(e){e.O(0,[7812,9774,2888,179],function(){return e(e.s=3836)}),_N_E=e.O()}]);